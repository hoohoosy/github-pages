name: Deploy Encrypted Dashboard

on:
  push:
    branches:
      - main
    paths:
      - 'STAT_daily_reve.csv'
      - 'generate.py'
      - 'template.html'
      - '.github/workflows/deploy.yml'

# GitHub Actions에 쓰기 권한 부여
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pandas

      # 1. CSV 데이터를 읽어와서 원본 HTML 대시보드 생성
      - name: Generate HTML
        run: python generate.py

      # 2. 암호화 수행 (질문/경고 자동 무시 설정 적용)
      - name: Encrypt HTML to Build Directory
        env:
          PASS: ${{ secrets.PAGE_PASSWORD }}
        run: |
          mkdir build_dir
          # yes y | 를 통해 짧은 비밀번호 경고에 강제로 'y'를 입력합니다.
          # npx -y 를 통해 패키지 설치 확인 질문을 건너뜁니다.
          yes y | npx -y staticrypt dashboard_raw.html --password "$PASS" -o build_dir/index.html --title "수익률 대시보드"
          
          echo "=== 파일 생성 결과 확인 ==="
          ls -al build_dir/

      # 3. 암호화된 index.html만 gh-pages 브랜치에 배포
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build_dir
          publish_branch: gh-pages
          force_orphan: true  # 기존 이력을 지우고 새로 배포하여 꼬임 방지